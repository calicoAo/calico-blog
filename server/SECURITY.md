# 安全策略文档

## 概述

本文档详细说明了 Calico Blog 项目的安全策略和实现。

## 已实现的安全措施

### 1. 速率限制（Rate Limiting）

**位置**: `server/middleware/rateLimit.js`

- **登录限制**: 15分钟内最多5次尝试
- **API 限制**: 15分钟内最多100次请求
- **严格限制**: 1小时内最多10次请求（用于敏感操作）

**作用**: 防止暴力破解和 DDoS 攻击

### 2. Helmet 安全头

**位置**: `server/index.js`

- 自动设置安全 HTTP 响应头
- 防止 XSS、点击劫持等攻击
- 配置了跨域资源策略

### 3. 请求日志（Morgan）

**位置**: `server/index.js`

- 开发环境：详细日志（`dev` 模式）
- 生产环境：标准日志（`combined` 模式）
- 记录所有 HTTP 请求

### 4. JWT 双 Token 机制

**Access Token**:
- 短期有效（默认15分钟）
- 用于 API 请求认证
- 存储在 localStorage

**Refresh Token**:
- 长期有效（默认7天）
- 用于刷新 Access Token
- 存储在 localStorage

**优势**:
- 减少 token 泄露风险
- 自动刷新机制
- 更好的安全控制

### 5. 密码安全

**存储加密**:
- 使用 bcrypt（成本因子 12）
- 单向哈希，不可逆

**传输加密**:
- 前端使用 AES 加密
- 后端解密后验证
- 密钥通过环境变量配置

### 6. 登录日志

**位置**: `server/models/LoginLog.js`

**记录内容**:
- 用户 ID（登录成功时）
- 邮箱地址
- 登录结果（成功/失败）
- IP 地址
- User-Agent
- 失败原因

**用途**:
- 安全审计
- 异常检测
- 攻击追踪

### 7. 统一错误信息

**实现**: `server/routes/auth.js`

- 登录失败时统一返回"邮箱或密码错误"
- 防止用户枚举攻击
- 真实原因记录在日志中

### 8. 输入验证

**位置**: `server/middleware/validation.js`

- 邮箱格式验证
- 密码强度验证
- 参数类型和范围验证
- 防止注入攻击

### 9. CORS 配置

**位置**: `server/index.js`

- 白名单机制
- 仅允许指定来源
- 支持凭证传递
- 预检请求优化

### 10. 自动 Token 刷新

**位置**: `client/src/lib/axios.ts`

- 401 错误时自动刷新 token
- 请求队列机制（防止并发刷新）
- 刷新失败自动跳转登录

## 安全最佳实践

### 1. 环境变量

**敏感信息必须使用环境变量**:
- JWT 密钥
- 数据库连接字符串
- 加密密钥
- API 密钥

### 2. Token 存储

**当前实现**: localStorage
- ✅ 简单易用
- ⚠️ 存在 XSS 风险

**生产环境建议**:
- 使用 HttpOnly Cookie（更安全）
- 或使用内存存储（刷新页面需重新登录）

### 3. HTTPS

**开发环境**: HTTP（可接受）
**生产环境**: 必须使用 HTTPS

### 4. 密码策略

**当前要求**:
- 最少6个字符

**建议增强**:
- 最少8个字符
- 包含大小写字母
- 包含数字
- 包含特殊字符

### 5. 账户锁定

**建议实现**:
- 连续失败5次后锁定账户
- 锁定时间：15分钟
- 管理员可手动解锁

### 6. 双因素认证（2FA）

**高级安全选项**:
- 短信验证码
- 邮箱验证码
- TOTP（时间-based 一次性密码）

## 安全监控

### 1. 异常登录检测

- 异地登录
- 异常 IP
- 异常时间
- 频繁失败

### 2. 日志分析

- 登录日志分析
- 访问日志分析
- 错误日志分析

### 3. 告警机制

- 异常登录告警
- 暴力破解告警
- 系统错误告警

## 待实现的安全功能

1. ✅ 速率限制
2. ✅ Helmet 安全头
3. ✅ 请求日志
4. ✅ Refresh Token
5. ✅ 登录日志
6. ✅ 统一错误信息
7. ⏳ Token 黑名单（Redis）
8. ⏳ 账户锁定机制
9. ⏳ 双因素认证
10. ⏳ 安全审计报告

## 安全配置检查清单

- [x] 使用环境变量存储敏感信息
- [x] 启用 HTTPS（生产环境）
- [x] 配置 CORS 白名单
- [x] 启用速率限制
- [x] 使用 Helmet 安全头
- [x] 密码加密存储（bcrypt）
- [x] 密码传输加密（AES）
- [x] JWT Token 过期时间合理
- [x] 实现 Refresh Token
- [x] 记录登录日志
- [x] 统一错误信息
- [x] 输入验证
- [x] 请求日志
- [ ] Token 黑名单（可选）
- [ ] 账户锁定（可选）
- [ ] 双因素认证（可选）

## 安全事件响应

### 发现安全漏洞时：

1. 立即评估影响范围
2. 修复漏洞
3. 更新安全策略
4. 通知受影响用户
5. 记录安全事件

### 遭受攻击时：

1. 立即隔离受影响系统
2. 分析攻击来源和方式
3. 修复安全漏洞
4. 恢复系统服务
5. 加强安全监控

## 参考资料

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [JWT Best Practices](https://datatracker.ietf.org/doc/html/rfc8725)
- [Express Security Best Practices](https://expressjs.com/en/advanced/best-practice-security.html)

